<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Play Game - CARBON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
  <style>
    .loader {
      border: 8px solid #16213e;
      border-top: 8px solid #06b6d4;
      border-radius: 50%;
      width: 70px;
      height: 70px;
      animation: spin 1s linear infinite;
      margin: auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    .tag-btn.active {
      background: #22d3ee22;
      color: #06b6d4 !important;
      border-color: #06b6d4 !important;
    }
    /* Comment section styles */
    .comment-item {
      transition: all 0.3s ease;
    }
    .comment-item:hover {
      background: rgba(6, 182, 212, 0.05);
    }
    .reply-item {
      border-left: 2px solid #06b6d4;
      margin-left: 1rem;
      padding-left: 1rem;
    }
    .reaction-picker {
      position: absolute;
      z-index: 1000;
      background: #232445;
      border: 1px solid #06b6d4;
      border-radius: 8px;
      padding: 8px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }
    .reaction-button {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 16px;
      font-size: 12px;
      background: rgba(6, 182, 212, 0.1);
      color: #06b6d4;
      border: 1px solid rgba(6, 182, 212, 0.3);
      transition: all 0.2s ease;
    }
    .reaction-button:hover {
      background: rgba(6, 182, 212, 0.2);
      transform: scale(1.05);
    }
    .reaction-button.reacted {
      background: rgba(6, 182, 212, 0.3);
      color: #22d3ee;
    }
    .comment-stars {
      color: #fbbf24;
    }
    .comment-textarea {
      background: rgba(24, 27, 42, 0.8);
      border: 1px solid rgba(6, 182, 212, 0.3);
      color: white;
      border-radius: 8px;
      padding: 12px;
      resize: vertical;
      min-height: 80px;
    }
    .comment-textarea:focus {
      outline: none;
      border-color: #06b6d4;
      box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
    }
    emoji-picker {
      --background: #232445;
      --border-color: #06b6d4;
      --button-active-background: rgba(6, 182, 212, 0.2);
      --button-hover-background: rgba(6, 182, 212, 0.1);
      --indicator-color: #06b6d4;
      --input-border-color: rgba(6, 182, 212, 0.3);
      --input-font-color: white;
      --input-background: rgba(24, 27, 42, 0.8);
      --outline-color: #06b6d4;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-[#0f0f23] via-[#1a1a2e] to-[#16213e] min-h-screen text-white font-[Inter]">

  <!-- Preloader -->
  <div id="preloader" class="fixed z-[9999] inset-0 flex flex-col justify-center items-center bg-gradient-to-br from-[#0f0f23] via-[#1a1a2e] to-[#16213e]">
    <div class="loader"></div>
  </div>

  <!-- Navbar -->
  <nav class="flex items-center justify-between px-8 py-4 bg-[#0f0f23cc] border-b border-white/10 backdrop-blur-md fixed top-0 left-0 right-0 z-50">
    <a href="index.html" class="text-2xl font-extrabold bg-gradient-to-r from-cyan-400 to-indigo-500 bg-clip-text text-transparent tracking-tighter">CARBON</a>
    <div class="flex items-center gap-4">
      <div id="userSection"></div>
    </div>
  </nav>

  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="flex flex-col items-center justify-center h-screen w-full bg-gradient-to-br from-[#0f0f23] via-[#1a1a2e] to-[#16213e] fixed left-0 top-0 z-50">
    <div class="bg-[#1a1a2e] rounded-2xl shadow-2xl p-12 border border-cyan-600/30 flex flex-col items-center">
      <div class="text-3xl font-bold bg-gradient-to-r from-cyan-400 to-indigo-500 bg-clip-text text-transparent mb-6">Sign In to Play</div>
      <button onclick="googleSignIn()" class="flex items-center gap-3 bg-cyan-500 hover:bg-cyan-400 text-black font-bold px-6 py-3 rounded-lg text-lg transition">
        <i class='bx bxl-google text-2xl'></i> Sign in with Google
      </button>
      <div id="loginError" class="text-pink-400 mt-6 hidden"></div>
    </div>
  </div>

  <main class="pt-28 max-w-4xl mx-auto px-4">
    <div id="gameInfoHolder" class="rounded-2xl shadow-2xl bg-[#181b2a] border border-cyan-600/30 overflow-hidden mt-2">
      <!-- Game "cover" with play button -->
      <div class="relative aspect-video bg-black flex items-center justify-center">
        <img id="gameCoverImg" src="" class="w-full h-full object-cover pointer-events-none select-none rounded-t-2xl" alt="Game Cover" />
        <button id="bigPlayBtn" class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-10 bg-gradient-to-br from-cyan-400 to-indigo-500 text-white font-extrabold rounded-lg px-6 py-3 shadow-lg text-lg hover:scale-105 transition-all flex items-center gap-3 group min-w-[120px]">
          <i class='bx bx-play-circle text-2xl drop-shadow-lg group-hover:scale-110 transition-transform'></i>
          <span class="block text-base font-bold">Play</span>
        </button>
        <div class="absolute bottom-4 left-4 flex gap-3">
          <span id="gameCategoryTag" class="bg-cyan-400/30 text-cyan-300 px-3 py-1 rounded text-xs font-semibold"></span>
          <span id="gameFeaturedTag" class="bg-indigo-400/30 text-indigo-200 px-3 py-1 rounded text-xs font-semibold hidden">Featured</span>
        </div>
      </div>
      <div class="flex flex-col md:flex-row p-6 gap-6 items-start bg-[#232445]">
        <div class="flex-1">
          <div id="gameTitleDisplay" class="text-2xl md:text-3xl font-extrabold text-cyan-400 mb-3"></div>
          <div id="starRatingSection" class="my-4">
            <div id="starsContainer" class="flex gap-1 text-3xl"></div>
            <div class="text-sm mt-1 flex flex-wrap items-center gap-2 text-cyan-200">
              <span id="starRatingSummary"></span>
              <span id="starRatingCount"></span>
              <span id="starRatingError" class="text-pink-400"></span>
            </div>
            <div id="ratingPercentContainer" class="flex items-center mt-2 gap-2">
              <span id="ratingPercentText" class="text-indigo-400 font-semibold"></span>
              <div class="w-40 h-2 bg-slate-700 rounded overflow-hidden">
                <div id="ratingPercentBar" class="h-2 bg-indigo-400 rounded transition-all duration-300" style="width:0%"></div>
              </div>
            </div>
          </div>
          <p id="gameFrameDesc" class="text-white/80 mb-2 text-base leading-relaxed"></p>
          <!-- Game info (dev/release/etc) with tailwind -->
          <div id="gameInfoBox" class="mt-6 w-full">
            <div class="bg-[#181b2a] border border-cyan-600/30 rounded-2xl px-6 py-5 text-white">
              <table class="w-full text-left">
                <tbody id="gameInfoTable"></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="flex flex-col gap-2 w-full md:w-auto">
          <button id="fullscreenBtn" class="bg-gradient-to-r from-cyan-400 to-indigo-500 text-black font-bold px-6 py-2 rounded-lg hover:scale-105 transition-transform">Fullscreen</button>
          <a href="profile.html" class="bg-white/10 text-white px-6 py-2 rounded-lg hover:bg-cyan-400/20 transition text-center">View Profile</a>
        </div>
      </div>
    </div>
    <!-- Real iframe, shown after play -->
    <div id="gameFrameContainer" class="rounded-2xl shadow-2xl bg-[#181b2a] border border-cyan-600/30 overflow-hidden mt-8 hidden">
      <div class="relative aspect-video bg-black">
        <iframe id="gameFrameEmbed" src="" class="w-full h-full" frameborder="0" allowfullscreen allow="fullscreen"></iframe>
        <div class="absolute top-4 right-4 flex gap-2 z-10">
          <button id="likeBtn" class="w-10 h-10 bg-white/10 hover:bg-cyan-500/80 text-white rounded-full flex items-center justify-center transition" title="Like">
            <i class='bx bx-like text-xl'></i>
          </button>
          <button id="favBtn" class="w-10 h-10 bg-white/10 hover:bg-pink-500/80 text-white rounded-full flex items-center justify-center transition" title="Favorite">
            <i class='bx bx-heart text-xl'></i>
          </button>
          <button id="dislikeBtn" class="w-10 h-10 bg-white/10 hover:bg-red-500/80 text-white rounded-full flex items-center justify-center transition" title="Dislike">
            <i class='bx bx-dislike text-xl'></i>
          </button>
          <button id="proxyToggleBtn" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center transition border-2 border-cyan-400" title="Toggle Proxy">
            <i id="proxyToggleIcon" class="bx bx-cloud text-xl"></i>
          </button>
          <button id="shareBtn" class="w-10 h-10 bg-white/10 hover:bg-indigo-500/80 text-white rounded-full flex items-center justify-center transition" title="Share">
            <i class='bx bx-share-alt text-xl'></i>
          </button>
          <button id="playlistBtn" class="w-10 h-10 bg-white/10 hover:bg-yellow-400/80 text-white rounded-full flex items-center justify-center transition" title="Add to Playlist">
            <i class='bx bx-list-plus text-xl'></i>
          </button>
        </div>
      </div>
      <div class="flex flex-col md:flex-row p-6 gap-6 items-start bg-[#232445]">
        <div class="flex-1">
          <div id="gameTitleDisplayFrame" class="text-2xl md:text-3xl font-extrabold text-cyan-400 mb-3"></div>
          <div id="starRatingSectionFrame" class="max-w-xl my-4">
            <div id="starsContainerFrame" class="flex gap-1 text-3xl"></div>
            <div class="text-sm mt-1 flex flex-wrap items-center gap-2 text-cyan-200">
              <span id="starRatingSummaryFrame"></span>
              <span id="starRatingCountFrame"></span>
              <span id="starRatingErrorFrame" class="text-pink-400"></span>
            </div>
            <div id="ratingPercentContainerFrame" class="flex items-center mt-2 gap-2">
              <span id="ratingPercentTextFrame" class="text-indigo-400 font-semibold"></span>
              <div class="w-40 h-2 bg-slate-700 rounded overflow-hidden">
                <div id="ratingPercentBarFrame" class="h-2 bg-indigo-400 rounded transition-all duration-300" style="width:0%"></div>
              </div>
            </div>
            <!-- Tag area -->
            <div id="tagsAreaFrame" class="mt-5 flex flex-wrap gap-2"></div>
            <!-- Category count -->
            <div id="categoryGamesCountFrame" class="mt-4 text-cyan-300 text-base font-semibold"></div>
          </div>
        </div>
        <div class="flex flex-col gap-2 w-full md:w-auto">
          <button id="fullscreenBtnBottom" class="bg-gradient-to-r from-cyan-400 to-indigo-500 text-black font-bold px-6 py-2 rounded-lg hover:scale-105 transition-transform">Fullscreen</button>
          <a href="profile.html" class="bg-white/10 text-white px-6 py-2 rounded-lg hover:bg-cyan-400/20 transition text-center">View Profile</a>
        </div>
      </div>
      <!-- Game info in frame panel -->
      <div id="gameInfoBoxFrame" class="mt-6 w-full">
        <div class="bg-[#181b2a] border border-cyan-600/30 rounded-2xl px-6 py-5 text-white mx-6 mb-8">
          <table class="w-full text-left">
            <tbody id="gameInfoTableFrame"></tbody>
          </table>
        </div>
      </div>

      <!-- Comments Section -->
      <div id="commentsSection" class="mt-8 mx-6 mb-8">
        <div class="bg-[#181b2a] border border-cyan-600/30 rounded-2xl px-6 py-6 text-white">
          <!-- Comments Header -->
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-2xl font-bold text-cyan-400 flex items-center gap-2">
              <i class='bx bx-message-square-dots text-3xl'></i>
              Reviews & Comments
              <span id="commentsCount" class="text-lg text-cyan-300 font-normal">
                (0)
              </span>
            </h3>
            
            <!-- Filter Dropdown -->
            <div class="relative">
              <select id="commentFilter" class="bg-[#232445] border border-cyan-600/30 text-white px-4 py-2 rounded-lg text-sm focus:outline-none focus:border-cyan-400">
                <option value="all">All Comments</option>
                <option value="5">⭐⭐⭐⭐⭐ (5 stars)</option>
                <option value="4">⭐⭐⭐⭐ (4 stars)</option>
                <option value="3">⭐⭐⭐ (3 stars)</option>
                <option value="2">⭐⭐ (2 stars)</option>
                <option value="1">⭐ (1 star)</option>
                <option value="no-rating">No Rating</option>
              </select>
            </div>
          </div>

          <!-- Add Comment Form -->
          <div id="addCommentForm" class="mb-6 p-4 bg-[#232445] rounded-lg border border-cyan-600/20">
            <h4 class="text-lg font-semibold text-cyan-400 mb-3">Write a Review</h4>
            
            <!-- Star Rating Input -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-cyan-300 mb-2">Your Rating (Optional)</label>
              <div id="commentStarInput" class="flex gap-1 text-2xl mb-2">
                <!-- Stars will be rendered here -->
              </div>
              <p class="text-xs text-cyan-200/70">Click stars to rate this game</p>
            </div>

            <!-- Comment Text -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-cyan-300 mb-2">Your Comment</label>
              <textarea 
                id="commentText" 
                placeholder="Share your thoughts about this game..."
                class="comment-textarea w-full"
                maxlength="1000"
              ></textarea>
              <div class="flex justify-between text-xs text-cyan-200/70 mt-1">
                <span>Be respectful and constructive</span>
                <span id="commentCharCount">0/1000</span>
              </div>
            </div>

            <!-- Submit Button -->
            <div class="flex gap-3">
              <button 
                id="submitComment" 
                class="bg-gradient-to-r from-cyan-400 to-indigo-500 text-black font-bold px-6 py-2 rounded-lg hover:scale-105 transition-transform disabled:opacity-50 disabled:cursor-not-allowed"
                disabled
              >
                <i class='bx bx-send mr-2'></i>
                Post Review
              </button>
              <button 
                id="cancelComment" 
                class="bg-white/10 text-white px-6 py-2 rounded-lg hover:bg-red-500/20 transition"
              >
                Cancel
              </button>
            </div>
          </div>

          <!-- Comments List -->
          <div id="commentsList" class="space-y-4">
            <!-- Comments will be rendered here -->
            <div id="commentsLoader" class="text-center py-8 hidden">
              <div class="inline-block w-6 h-6 border-2 border-cyan-400 border-t-transparent rounded-full animate-spin"></div>
              <p class="text-cyan-300 mt-2">Loading comments...</p>
            </div>
            <div id="noComments" class="text-center py-8 text-cyan-300/70">
              <i class='bx bx-message-square text-4xl mb-2 block'></i>
              <p>No comments yet. Be the first to share your thoughts!</p>
            </div>
          </div>

          <!-- Load More Button -->
          <div id="loadMoreComments" class="text-center mt-6 hidden">
            <button class="bg-white/10 text-cyan-300 px-6 py-2 rounded-lg hover:bg-cyan-500/20 transition">
              Load More Comments
            </button>
          </div>
        </div>
      </div>

      <!-- Reply Modal -->
      <div id="replyModal" class="hidden fixed inset-0 z-[10001] bg-black/70 flex items-center justify-center">
        <div class="bg-[#232445] rounded-xl p-6 max-w-lg w-full mx-4 shadow-2xl border border-cyan-400/20 relative">
          <button onclick="closeReplyModal()" class="absolute top-3 right-4 text-white/70 hover:text-pink-400 text-xl">
            <i class='bx bx-x'></i>
          </button>
          <h3 class="text-xl font-bold mb-4 text-cyan-400">Reply to Comment</h3>
          
          <div id="replyToComment" class="mb-4 p-3 bg-[#181b2a] rounded-lg border border-cyan-600/20">
            <!-- Original comment will be shown here -->
          </div>
          
          <textarea 
            id="replyText" 
            placeholder="Write your reply..."
            class="comment-textarea w-full mb-4"
            maxlength="500"
          ></textarea>
          <div class="text-xs text-cyan-200/70 mb-4 text-right">
            <span id="replyCharCount">0/500</span>
          </div>
          
          <div class="flex gap-3">
            <button 
              id="submitReply" 
              class="bg-gradient-to-r from-cyan-400 to-indigo-500 text-black font-bold px-4 py-2 rounded-lg hover:scale-105 transition-transform disabled:opacity-50"
              disabled
            >
              Post Reply
            </button>
            <button 
              onclick="closeReplyModal()" 
              class="bg-white/10 text-white px-4 py-2 rounded-lg hover:bg-red-500/20 transition"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>

      <!-- Reaction Picker (will be positioned dynamically) -->
      <div id="reactionPicker" class="hidden reaction-picker">
        <emoji-picker></emoji-picker>
      </div>

      <div id="tagGamesListModal" class="hidden fixed inset-0 z-[10000] bg-black/70 flex items-center justify-center">
        <div class="bg-[#232445] rounded-xl p-8 max-w-lg w-full shadow-2xl border border-cyan-400/20 relative">
          <button onclick="closeTagGamesModal()" class="absolute top-3 right-4 text-white/70 hover:text-pink-400 text-xl"><i class='bx bx-x'></i></button>
          <h2 class="text-2xl font-bold mb-4 text-cyan-400" id="tagGamesListTitle"></h2>
          <div id="tagGamesListBody" class="space-y-2"></div>
        </div>
      </div>
    </div>
  </main>

  
  <script type="module">
    import {
      makeURL,
      getProxied,
      setProxy,
      getProxy,
      setTransport,
      setWisp,
    } from "/lethal.mjs";
    let proxyOption = localStorage.getItem("proxy-backend") || "uv";
    async function ensureProxyReady() {
      if (!getProxy() || getProxy() !== proxyOption) await setProxy(proxyOption);
      let wisp = localStorage.getItem("wisp-server") || "wss://anura.pro/";
      let transport = localStorage.getItem("proxy-transport");
      if (wisp) await setWisp(wisp);
      if (transport) await setTransport(transport);
      else if (navigator.userAgent.indexOf("Firefox") > 0) await setTransport("libcurl");
      else await setTransport("epoxy");
    }
    function updateProxyToggleUI(proxy) {
      const proxyToggleBtn = document.getElementById("proxyToggleBtn");
      const proxyToggleIcon = document.getElementById("proxyToggleIcon");
      if (!proxyToggleBtn || !proxyToggleIcon) return;
      if (proxy === "scram") {
        proxyToggleBtn.classList.remove("border-cyan-400");
        proxyToggleBtn.classList.add("border-gold", "bg-gold/20");
        proxyToggleIcon.className = "bx bx-network-chart text-xl";
        proxyToggleBtn.title = "Scramjet";
      } else {
        proxyToggleBtn.classList.remove("border-gold", "bg-gold/20");
        proxyToggleBtn.classList.add("border-cyan-400");
        proxyToggleIcon.className = "bx bx-cloud text-xl";
        proxyToggleBtn.title = "UV";
      }
    }
    document.getElementById("proxyToggleBtn").addEventListener("click", async () => {
      proxyOption = (getProxy() === "scram") ? "uv" : "scram";
      localStorage.setItem("proxy-backend", proxyOption);
      await ensureProxyReady();
      updateProxyToggleUI(proxyOption);
      if (!document.getElementById("gameFrameContainer").classList.contains("hidden")) {
        loadProxiedGameIframe();
      }
    });
    updateProxyToggleUI(proxyOption);

    async function loadProxiedGameIframe() {
      await ensureProxyReady();
      let gamesData = window.gamesData || [];
      let currentGameId = window.currentGameId;
      let currentGame = gamesData.find(g => String(g.id) === String(currentGameId));
      if (!currentGame) return;
      const proxied = await getProxied(currentGame.url);
      document.getElementById("gameFrameEmbed").src = proxied;
    }
    window.loadProxiedGameIframe = loadProxiedGameIframe;
    window.ensureProxyReady = ensureProxyReady;
    window.updateProxyToggleUI = updateProxyToggleUI;
  </script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC4ilHYP1T-kdXbWPoHJHhD2aj0pNWmMec",
      authDomain: "carbon-services.firebaseapp.com",
      projectId: "carbon-services",
      storageBucket: "carbon-services.firebasestorage.app",
      messagingSenderId: "288385472070",
      appId: "1:288385472070:web:c4be3ff186e248fc645c47",
      measurementId: "G-Y2K1RQYE74"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    function googleSignIn() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .catch((error) => {
          document.getElementById('loginError').innerText = error.message;
          document.getElementById('loginError').classList.remove('hidden');
        });
    }
    function signOut() {
      auth.signOut().then(() => location.reload());
    }

    let gamesData = [];
    let currentGameId = null;
    let currentGame = null;
    let categoryCounts = {};
    let tagCounts = {};

    async function loadGamesData() {
      const res = await fetch('games.json');
      gamesData = await res.json();
      window.gamesData = gamesData;
      // Build category and tag counts for tag modal
      categoryCounts = {};
      tagCounts = {};
      gamesData.forEach(game => {
        if (game.category) categoryCounts[game.category] = (categoryCounts[game.category] || 0) + 1;
        if (game.tags && Array.isArray(game.tags)) {
          game.tags.forEach(t => tagCounts[t] = (tagCounts[t] || 0) + 1);
        }
      });
      window.categoryCounts = categoryCounts;
      window.tagCounts = tagCounts;
    }

    function getGameIdFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('id');
    }
    function setButtonActive(btn, isActive, activeClass='bg-cyan-500/80') {
      btn.classList.toggle(activeClass, isActive);
    }
    function renderUserSection(user) {
      const section = document.getElementById('userSection');
      if (!user) {
        section.innerHTML = '';
      } else {
        section.innerHTML = `
          <img src="${user.photoURL}" class="w-8 h-8 rounded-full inline mr-2" title="${user.displayName}">
          <span class="mr-3">${user.displayName}</span>
          <button onclick="signOut()" class="bg-white/10 px-3 py-1 rounded hover:bg-pink-600 text-white">Sign Out</button>
        `;
      }
    }
    function showPreloader() {
      document.getElementById('preloader').style.display = '';
    }
    function hidePreloader() {
      document.getElementById('preloader').style.display = 'none';
    }
    function requestFullScreen(element) {
      if (element.requestFullscreen) element.requestFullscreen();
      else if (element.webkitRequestFullscreen) element.webkitRequestFullscreen();
      else if (element.msRequestFullscreen) element.msRequestFullscreen();
      else if (element.mozRequestFullScreen) element.mozRequestFullScreen();
    }

    // --- STAR RATING SYSTEM ---
    let starRatingData = {
      average: 0,
      count: 0,
      yourRating: 0,
      loading: false,
      error: "",
      percent: 0
    };

    function renderStarRatingUI(target = "") {
      const pre = target ? target : "";
      const container = document.getElementById('starsContainer' + pre);
      if (!container) return;
      container.innerHTML = '';
      let fill = starRatingData.yourRating ? starRatingData.yourRating : Math.round(starRatingData.average);
      for (let i = 1; i <= 5; i++) {
        const star = document.createElement('span');
        star.textContent = '★';
        star.className = 'transition-colors duration-150 select-none ' +
          (i <= fill ? 'text-yellow-400' : 'text-slate-600') +
          (firebase.auth().currentUser ? ' cursor-pointer hover:text-yellow-300' : ' cursor-not-allowed');
        if (firebase.auth().currentUser) {
          star.addEventListener('mouseenter', () => {
            for (let j = 0; j < 5; j++) container.children[j].classList.toggle('text-yellow-400', j < i);
            for (let j = i; j < 5; j++) container.children[j].classList.toggle('text-slate-600', j >= i);
          });
          star.addEventListener('mouseleave', () => {
            for (let j = 0; j < 5; j++) {
              container.children[j].classList.toggle('text-yellow-400', j < fill);
              container.children[j].classList.toggle('text-slate-600', j >= fill);
            }
          });
          star.addEventListener('click', async () => {
            await submitStarRating(i);
          });
        }
        container.appendChild(star);
      }
      document.getElementById('starRatingSummary' + pre).textContent =
        starRatingData.count ? `${starRatingData.average.toFixed(2)} / 5` : "Not rated";
      document.getElementById('starRatingCount' + pre).textContent =
        starRatingData.count === 1 ? "1 rating" : (starRatingData.count ? `${starRatingData.count} ratings` : "");
      document.getElementById('starRatingError' + pre).textContent = starRatingData.error || '';
      renderRatingPercentUI(target);
    }

    async function loadStarRating(gameId) {
      starRatingData.loading = true;
      starRatingData.error = "";
      starRatingData.average = 0;
      starRatingData.count = 0;
      starRatingData.yourRating = 0;
      starRatingData.percent = 0;
      try {
        const ratingsRef = db.collection("games").doc(gameId).collection("ratings");
        const snap = await ratingsRef.get();
        let total = 0, count = 0, your = 0, user = firebase.auth().currentUser;
        let highCount = 0;
        snap.forEach(doc => {
          const d = doc.data();
          if (typeof d.rating === "number" && d.rating >= 1 && d.rating <= 5) {
            total += d.rating;
            count++;
            if (d.rating >= 4) highCount++;
            if (user && doc.id === user.uid) your = d.rating;
          }
        });
        starRatingData.average = count ? total / count : 0;
        starRatingData.count = count;
        starRatingData.yourRating = your;
        starRatingData.percent = count ? Math.round((highCount / count) * 100) : 0;
      } catch (e) {
        starRatingData.error = "Failed to load ratings.";
      }
      starRatingData.loading = false;
      renderStarRatingUI();
      renderStarRatingUI("Frame");
    }

    async function submitStarRating(stars) {
      if (!firebase.auth().currentUser) {
        starRatingData.error = "Sign in first!";
        renderStarRatingUI();
        renderStarRatingUI("Frame");
        return;
      }
      if (!currentGameId) {
        starRatingData.error = "Game not loaded!";
        renderStarRatingUI();
        renderStarRatingUI("Frame");
        return;
      }
      if (stars < 1 || stars > 5) {
        starRatingData.error = "Invalid rating value!";
        renderStarRatingUI();
        renderStarRatingUI("Frame");
        return;
      }
      starRatingData.loading = true;
      starRatingData.error = "";
      renderStarRatingUI();
      renderStarRatingUI("Frame");
      try {
        const ref = db.collection("games").doc(currentGameId).collection("ratings").doc(firebase.auth().currentUser.uid);
        await ref.set({
          rating: stars,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        starRatingData.yourRating = stars;
        await loadStarRating(currentGameId);
      } catch (e) {
        starRatingData.error = "Failed to rate, try again.";
        renderStarRatingUI();
        renderStarRatingUI("Frame");
      }
      starRatingData.loading = false;
      renderStarRatingUI();
      renderStarRatingUI("Frame");
    }

    function renderRatingPercentUI(target = "") {
      const pre = target ? target : "";
      const txt = document.getElementById('ratingPercentText' + pre);
      const bar = document.getElementById('ratingPercentBar' + pre);
      if (!txt || !bar) return;
      if (starRatingData.count === 0) {
        txt.textContent = "Not enough ratings yet";
        bar.style.width = "0%";
      } else {
        txt.textContent = `${starRatingData.percent}% of raters gave 4 or 5 stars`;
        bar.style.width = `${starRatingData.percent}%`;
      }
    }

    // --- Tag Modal Logic ---
    function openTagGamesModal(tag) {
      const modal = document.getElementById('tagGamesListModal');
      const title = document.getElementById('tagGamesListTitle');
      const body = document.getElementById('tagGamesListBody');
      // List all games with this tag
      const games = gamesData.filter(g => g.tags && g.tags.includes(tag));
      title.innerHTML = `${tag.charAt(0).toUpperCase() + tag.slice(1)} <span class="text-cyan-400/70 text-base">(${games.length} game${games.length!==1?'s':''})</span>`;
      body.innerHTML = games.length ? games.map(g => `
        <a href="play.html?id=${g.id}" class="block px-4 py-2 bg-white/5 rounded-md hover:bg-cyan-500/20 text-white/90 font-semibold transition">
          ${g.title}
        </a>
      `).join('') : `<div class="text-white/60">No games in this category.</div>`;
      modal.classList.remove("hidden");
    }
    function closeTagGamesModal() {
      document.getElementById('tagGamesListModal').classList.add('hidden');
    }

    // --- Category count info below rating in the iframe panel
    function renderCategoryGamesCountFrame(currentGame) {
      const el = document.getElementById('categoryGamesCountFrame');
      if (!el || !currentGame || !currentGame.category || !window.categoryCounts) {
        if (el) el.textContent = "";
        return;
      }
      const cat = currentGame.category;
      const count = window.categoryCounts[cat] || 0;
      el.textContent = `${cat.charAt(0).toUpperCase() + cat.slice(1)} (${count}) games`;
    }

    function renderTagsAreaFrame(currentGame) {
      const el = document.getElementById('tagsAreaFrame');
      if (!el) return;
      if (!currentGame || !currentGame.tags || !currentGame.tags.length) {
        el.innerHTML = "";
        return;
      }
      el.innerHTML = currentGame.tags.map(tag => `
        <button type="button"
          class="tag-btn inline-block px-3 py-1 bg-gradient-to-r from-cyan-400/20 to-indigo-500/20 text-cyan-300 text-xs rounded-full border border-cyan-400/30 hover:bg-cyan-600/10 transition font-semibold"
          onclick="openTagGamesModal('${tag}')"
          >
          ${tag.charAt(0).toUpperCase() + tag.slice(1)} <span class="text-cyan-400/70">(${window.tagCounts[tag]||1})</span>
        </button>
      `).join('');
    }

    
    function renderGameInfoBox(game, tableId) {
      const el = document.getElementById(tableId);
      if (!el) return;
      el.innerHTML = `
        <tr>
          <th class="pr-4 py-1 text-cyan-400 font-semibold align-top">Developer</th>
          <td class="py-1">${game.developer || "Unknown"}</td>
        </tr>
        <tr>
          <th class="pr-4 py-1 text-cyan-400 font-semibold align-top">Release</th>
          <td class="py-1">${game.release || "Unknown"}</td>
        </tr>
        <tr>
          <th class="pr-4 py-1 text-cyan-400 font-semibold align-top">Technology</th>
          <td class="py-1">${game.technology || "Unknown"}</td>
        </tr>
        <tr>
          <th class="pr-4 py-1 text-cyan-400 font-semibold align-top">Platforms</th>
          <td class="flex flex-wrap gap-2 py-1">
            ${(Array.isArray(game.platforms) ? game.platforms.map(p => `<span class="bg-[#232445] text-cyan-300 px-2 py-[2px] rounded-full text-xs font-semibold">${p}</span>`).join('') : (game.platforms || "Unknown"))}
          </td>
        </tr>
        <tr>
          <th class="pr-4 py-1 text-cyan-400 font-semibold align-top">Controls</th>
          <td class="py-1">${game.controls || "See in-game"}</td>
        </tr>
      `;
    }

    // --- COMMENT SYSTEM ---
    let commentsData = {
      comments: [],
      loading: false,
      currentFilter: 'all',
      currentCommentRating: 0,
      currentReplyingTo: null,
      lastVisible: null,
      commentsPerPage: 10
    };

    // Initialize comment star rating input
    function initCommentStarInput() {
      const container = document.getElementById('commentStarInput');
      if (!container) return;
      
      container.innerHTML = '';
      for (let i = 1; i <= 5; i++) {
        const star = document.createElement('span');
        star.textContent = '★';
        star.className = 'cursor-pointer transition-colors duration-150 select-none ' + 
          (i <= commentsData.currentCommentRating ? 'text-yellow-400' : 'text-slate-600');
        
        star.addEventListener('mouseenter', () => {
          for (let j = 0; j < 5; j++) {
            container.children[j].classList.toggle('text-yellow-400', j < i);
            container.children[j].classList.toggle('text-slate-600', j >= i);
          }
        });
        
        star.addEventListener('mouseleave', () => {
          for (let j = 0; j < 5; j++) {
            container.children[j].classList.toggle('text-yellow-400', j < commentsData.currentCommentRating);
            container.children[j].classList.toggle('text-slate-600', j >= commentsData.currentCommentRating);
          }
        });
        
        star.addEventListener('click', () => {
          commentsData.currentCommentRating = commentsData.currentCommentRating === i ? 0 : i;
          updateCommentStarInput();
        });
        
        container.appendChild(star);
      }
    }

    function updateCommentStarInput() {
      const container = document.getElementById('commentStarInput');
      if (!container) return;
      
      for (let j = 0; j < 5; j++) {
        container.children[j].classList.toggle('text-yellow-400', j < commentsData.currentCommentRating);
        container.children[j].classList.toggle('text-slate-600', j >= commentsData.currentCommentRating);
      }
    }

    // Load comments from Firebase
    async function loadComments(gameId, loadMore = false) {
      if (!gameId) return;
      
      commentsData.loading = true;
      updateCommentsUI();
      
      try {
        let query = db.collection("games").doc(gameId).collection("comments")
          .orderBy("createdAt", "desc")
          .limit(commentsData.commentsPerPage);
        
        if (loadMore && commentsData.lastVisible) {
          query = query.startAfter(commentsData.lastVisible);
        }
        
        const snapshot = await query.get();
        
        if (loadMore) {
          snapshot.forEach(doc => {
            commentsData.comments.push({ id: doc.id, ...doc.data() });
          });
        } else {
          commentsData.comments = [];
          snapshot.forEach(doc => {
            commentsData.comments.push({ id: doc.id, ...doc.data() });
          });
        }
        
        commentsData.lastVisible = snapshot.docs[snapshot.docs.length - 1] || null;
        
        // Load replies for each comment
        for (let comment of commentsData.comments) {
          if (!comment.replies) {
            const repliesSnapshot = await db.collection("games").doc(gameId)
              .collection("comments").doc(comment.id)
              .collection("replies")
              .orderBy("createdAt", "asc")
              .get();
            
            comment.replies = [];
            repliesSnapshot.forEach(replyDoc => {
              comment.replies.push({ id: replyDoc.id, ...replyDoc.data() });
            });
          }
        }
        
      } catch (error) {
        console.error("Error loading comments:", error);
      }
      
      commentsData.loading = false;
      updateCommentsUI();
    }

    // Submit new comment
    async function submitComment() {
      const user = firebase.auth().currentUser;
      const text = document.getElementById('commentText').value.trim();
      
      if (!user) {
        alert('Please sign in to comment');
        return;
      }
      
      if (!text) {
        alert('Please enter a comment');
        return;
      }
      
      if (!currentGameId) {
        alert('Game not loaded');
        return;
      }
      
      try {
        const commentData = {
          text: text,
          rating: commentsData.currentCommentRating || null,
          authorId: user.uid,
          authorName: user.displayName,
          authorPhoto: user.photoURL,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          reactions: {},
          reactionCounts: {}
        };
        
        const docRef = await db.collection("games").doc(currentGameId)
          .collection("comments").add(commentData);
        
        // Reset form
        document.getElementById('commentText').value = '';
        commentsData.currentCommentRating = 0;
        updateCommentStarInput();
        updateSubmitButtonState();
        
        // Reload comments
        await loadComments(currentGameId);
        
      } catch (error) {
        console.error("Error submitting comment:", error);
        alert('Failed to submit comment. Please try again.');
      }
    }

    // Submit reply
    async function submitReply() {
      const user = firebase.auth().currentUser;
      const text = document.getElementById('replyText').value.trim();
      
      if (!user || !text || !commentsData.currentReplyingTo) {
        return;
      }
      
      try {
        const replyData = {
          text: text,
          authorId: user.uid,
          authorName: user.displayName,
          authorPhoto: user.photoURL,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          reactions: {},
          reactionCounts: {}
        };
        
        await db.collection("games").doc(currentGameId)
          .collection("comments").doc(commentsData.currentReplyingTo)
          .collection("replies").add(replyData);
        
        closeReplyModal();
        await loadComments(currentGameId);
        
      } catch (error) {
        console.error("Error submitting reply:", error);
        alert('Failed to submit reply. Please try again.');
      }
    }

    // Add or remove reaction
    async function toggleReaction(commentId, emoji, isReply = false, replyId = null) {
      const user = firebase.auth().currentUser;
      if (!user || !currentGameId) {
        console.log('User not authenticated or game not loaded');
        return;
      }
      
      try {
        let docPath = `games/${currentGameId}/comments/${commentId}`;
        if (isReply) {
          docPath += `/replies/${replyId}`;
        }
        
        const docRef = db.doc(docPath);
        const doc = await docRef.get();
        
        if (!doc.exists) {
          console.error('Document does not exist:', docPath);
          return;
        }
        
        const data = doc.data();
        const reactions = data.reactions || {};
        const reactionCounts = data.reactionCounts || {};
        
        // Toggle user's reaction
        if (reactions[user.uid] === emoji) {
          // Remove reaction
          delete reactions[user.uid];
          reactionCounts[emoji] = Math.max(0, (reactionCounts[emoji] || 1) - 1);
          if (reactionCounts[emoji] === 0) {
            delete reactionCounts[emoji];
          }
        } else {
          // Add/change reaction
          const oldEmoji = reactions[user.uid];
          if (oldEmoji) {
            reactionCounts[oldEmoji] = Math.max(0, (reactionCounts[oldEmoji] || 1) - 1);
            if (reactionCounts[oldEmoji] === 0) {
              delete reactionCounts[oldEmoji];
            }
          }
          reactions[user.uid] = emoji;
          reactionCounts[emoji] = (reactionCounts[emoji] || 0) + 1;
        }
        
        await docRef.update({ reactions, reactionCounts });
        await loadComments(currentGameId);
        
      } catch (error) {
        console.error("Error toggling reaction:", error);
        alert('Failed to add reaction. Please try again.');
      }
    }

    // Modal functions
    function openReplyModal(commentId) {
      const comment = commentsData.comments.find(c => c.id === commentId);
      if (!comment) return;
      
      commentsData.currentReplyingTo = commentId;
      const modal = document.getElementById('replyModal');
      const replyTo = document.getElementById('replyToComment');
      
      const stars = comment.rating ? 
        '★'.repeat(comment.rating) + '☆'.repeat(5 - comment.rating) : '';
      
      replyTo.innerHTML = `
        <div class="flex items-start gap-3">
          <img src="${comment.authorPhoto || '/default-avatar.png'}" 
               class="w-8 h-8 rounded-full flex-shrink-0" 
               alt="${comment.authorName}">
          <div>
            <div class="flex items-center gap-2 mb-1">
              <span class="font-medium text-cyan-300 text-sm">${comment.authorName}</span>
              ${comment.rating ? `<span class="comment-stars text-xs">${stars}</span>` : ''}
            </div>
            <p class="text-white/80 text-sm">${escapeHtml(comment.text.slice(0, 100))}${comment.text.length > 100 ? '...' : ''}</p>
          </div>
        </div>
      `;
      
      modal.classList.remove('hidden');
      document.getElementById('replyText').focus();
    }

    function closeReplyModal() {
      document.getElementById('replyModal').classList.add('hidden');
      document.getElementById('replyText').value = '';
      commentsData.currentReplyingTo = null;
      updateReplyButtonState();
    }

    // Reaction picker
    function showReactionPicker(commentId, event, isReply = false, replyId = null) {
      event.stopPropagation();
      const picker = document.getElementById('reactionPicker');
      const emojiPicker = picker.querySelector('emoji-picker');
      
      // Position picker near the clicked button
      const rect = event.target.closest('button').getBoundingClientRect();
      picker.style.position = 'fixed';
      picker.style.left = rect.left + 'px';
      picker.style.top = (rect.bottom + 10) + 'px';
      picker.style.zIndex = '10002';
      
      picker.classList.remove('hidden');
      
      // Remove any existing listeners
      const oldPicker = picker.querySelector('emoji-picker');
      if (oldPicker) {
        oldPicker.remove();
      }
      
      // Create new emoji picker
      const newEmojiPicker = document.createElement('emoji-picker');
      picker.appendChild(newEmojiPicker);
      
      // Handle emoji selection
      const handleEmojiClick = (e) => {
        toggleReaction(commentId, e.detail.unicode, isReply, replyId);
        hideReactionPicker();
      };
      
      newEmojiPicker.addEventListener('emoji-click', handleEmojiClick, { once: true });
    }

    function hideReactionPicker() {
      const picker = document.getElementById('reactionPicker');
      if (picker) {
        picker.classList.add('hidden');
      }
    }

    // Utility functions
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Expose all functions to global scope immediately
    window.openReplyModal = openReplyModal;
    window.closeReplyModal = closeReplyModal;
    window.showReactionPicker = showReactionPicker;
    window.toggleReaction = toggleReaction;
    window.submitComment = submitComment;
    window.submitReply = submitReply;
    window.loadComments = loadComments;

    // Render comments
    function renderComments() {
      const container = document.getElementById('commentsList');
      const noComments = document.getElementById('noComments');
      const loader = document.getElementById('commentsLoader');
      const loadMore = document.getElementById('loadMoreComments');
      
      if (commentsData.loading) {
        if (loader) loader.classList.remove('hidden');
        if (noComments) noComments.classList.add('hidden');
        return;
      }
      
      if (loader) loader.classList.add('hidden');
      
      const filteredComments = filterComments(commentsData.comments);
      
      if (filteredComments.length === 0) {
        if (noComments) noComments.classList.remove('hidden');
        if (container) container.innerHTML = '';
        if (loadMore) loadMore.classList.add('hidden');
        return;
      }
      
      if (noComments) noComments.classList.add('hidden');
      
      if (container) {
        container.innerHTML = filteredComments.map(comment => renderComment(comment)).join('');
      }
      
      // Show load more if there might be more comments
      if (loadMore) {
        if (commentsData.lastVisible && filteredComments.length >= commentsData.commentsPerPage) {
          loadMore.classList.remove('hidden');
        } else {
          loadMore.classList.add('hidden');
        }
      }
      
      updateCommentsCount();
    }

    function renderComment(comment) {
      const user = firebase.auth().currentUser;
      const reactions = Object.entries(comment.reactionCounts || {})
        .map(([emoji, count]) => {
          const userReacted = user && comment.reactions && comment.reactions[user.uid] === emoji;
          return `
            <button 
              onclick="toggleReaction('${comment.id}', '${emoji}')"
              class="reaction-button ${userReacted ? 'reacted' : ''}"
            >
              ${emoji} ${count}
            </button>
          `;
        }).join('');
      
      const replies = (comment.replies || [])
        .map(reply => renderReply(reply, comment.id))
        .join('');
      
      const stars = comment.rating ? 
        '★'.repeat(comment.rating) + '☆'.repeat(5 - comment.rating) : '';
      
      return `
        <div class="comment-item p-4 bg-[#232445] rounded-lg border border-cyan-600/20">
          <div class="flex items-start gap-3">
            <img src="${comment.authorPhoto || '/default-avatar.png'}" 
                 class="w-10 h-10 rounded-full flex-shrink-0" 
                 alt="${comment.authorName}">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-2">
                <span class="font-semibold text-cyan-300">${comment.authorName}</span>
                ${comment.rating ? `<span class="comment-stars text-sm">${stars}</span>` : ''}
                <span class="text-xs text-cyan-200/60">
                  ${comment.createdAt ? new Date(comment.createdAt.toDate()).toLocaleDateString() : 'Just now'}
                </span>
              </div>
              
              <p class="text-white/90 mb-3 leading-relaxed">${escapeHtml(comment.text)}</p>
              
              <div class="flex items-center gap-3 flex-wrap">
                <div class="flex gap-1">
                  ${reactions}
                </div>
                
                <button 
                  onclick="showReactionPicker('${comment.id}', event)"
                  class="text-cyan-400 hover:text-cyan-300 text-sm flex items-center gap-1"
                  title="Add reaction"
                >
                  <i class='bx bx-smile'></i>
                  React
                </button>
                
                <button 
                  onclick="openReplyModal('${comment.id}')"
                  class="text-cyan-400 hover:text-cyan-300 text-sm flex items-center gap-1"
                  title="Reply to comment"
                >
                  <i class='bx bx-reply'></i>
                  Reply
                </button>
              </div>
              
              ${replies ? `
                <div class="mt-4 space-y-3">
                  ${replies}
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }

    function renderReply(reply, commentId) {
      const user = firebase.auth().currentUser;
      const reactions = Object.entries(reply.reactionCounts || {})
        .map(([emoji, count]) => {
          const userReacted = user && reply.reactions && reply.reactions[user.uid] === emoji;
          return `
            <button 
              onclick="toggleReaction('${commentId}', '${emoji}', true, '${reply.id}')"
              class="reaction-button ${userReacted ? 'reacted' : ''}"
            >
              ${emoji} ${count}
            </button>
          `;
        }).join('');
      
      return `
        <div class="reply-item p-3 bg-[#181b2a] rounded-lg">
          <div class="flex items-start gap-3">
            <img src="${reply.authorPhoto || '/default-avatar.png'}" 
                 class="w-8 h-8 rounded-full flex-shrink-0" 
                 alt="${reply.authorName}">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-2">
                <span class="font-medium text-cyan-300 text-sm">${reply.authorName}</span>
                <span class="text-xs text-cyan-200/60">
                  ${reply.createdAt ? new Date(reply.createdAt.toDate()).toLocaleDateString() : 'Just now'}
                </span>
              </div>
              
              <p class="text-white/90 text-sm mb-2 leading-relaxed">${escapeHtml(reply.text)}</p>
              
              <div class="flex items-center gap-3">
                <div class="flex gap-1">
                  ${reactions}
                </div>
                
                <button 
                  onclick="showReactionPicker('${commentId}', event, true, '${reply.id}')"
                  class="text-cyan-400 hover:text-cyan-300 text-xs flex items-center gap-1"
                  title="Add reaction"
                >
                  <i class='bx bx-smile'></i>
                  React
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function filterComments(comments) {
      if (commentsData.currentFilter === 'all') {
        return comments;
      }
      
      if (commentsData.currentFilter === 'no-rating') {
        return comments.filter(c => !c.rating);
      }
      
      const rating = parseInt(commentsData.currentFilter);
      return comments.filter(c => c.rating === rating);
    }

    function updateCommentsUI() {
      renderComments();
    }

    function updateCommentsCount() {
      const count = filterComments(commentsData.comments).length;
      const countEl = document.getElementById('commentsCount');
      if (countEl) {
        countEl.textContent = `(${count})`;
      }
    }

    function updateSubmitButtonState() {
      const text = document.getElementById('commentText');
      const button = document.getElementById('submitComment');
      if (text && button) {
        button.disabled = !text.value.trim();
      }
    }

    function updateReplyButtonState() {
      const text = document.getElementById('replyText');
      const button = document.getElementById('submitReply');
      if (text && button) {
        button.disabled = !text.value.trim();
      }
    }

    // Expose modal controls for tag modal
    window.openTagGamesModal = openTagGamesModal;
    window.closeTagGamesModal = closeTagGamesModal;
    window.googleSignIn = googleSignIn;
    window.signOut = signOut;

    // Re-initialize the main document loading logic
    document.addEventListener('DOMContentLoaded', async () => {
      showPreloader();
      document.getElementById('gameFrameContainer').classList.add('hidden');
      document.getElementById('gameInfoHolder').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
      
      auth.onAuthStateChanged(async (user) => {
        renderUserSection(user);
        if (!user) {
          hidePreloader();
          document.getElementById('loginScreen').classList.remove('hidden');
          document.getElementById('gameFrameContainer').classList.add('hidden');
          document.getElementById('gameInfoHolder').classList.add('hidden');
          return;
        }
        
        await loadGamesData();
        currentGameId = getGameIdFromURL();
        window.currentGameId = currentGameId;
        currentGame = gamesData.find(g => g.id == currentGameId || String(g.id) == currentGameId);
        
        if (!currentGame) {
          hidePreloader();
          document.getElementById('gameInfoHolder').innerHTML = `<div class="text-center p-12 text-red-400">Game not found.</div>`;
          document.getElementById('gameInfoHolder').classList.remove('hidden');
          return;
        }
        
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('gameInfoHolder').classList.remove('hidden');
        document.getElementById('gameCoverImg').src = currentGame.image;
        document.getElementById('gameTitleDisplay').textContent = currentGame.title || "";
        document.getElementById('gameFrameDesc').textContent = currentGame.description;
        document.getElementById('gameCategoryTag').textContent = currentGame.category || '';
        
        if (currentGame.featured) document.getElementById('gameFeaturedTag').classList.remove('hidden');
        else document.getElementById('gameFeaturedTag').classList.add('hidden');
        
        await loadStarRating(currentGameId);
        renderGameInfoBox(currentGame, "gameInfoTable");

        // Initialize comment system early
        initializeCommentSystem();

        document.getElementById('bigPlayBtn').onclick = async () => {
          showPreloader();
          document.getElementById('gameInfoHolder').classList.add('hidden');
          document.getElementById('gameFrameContainer').classList.remove('hidden');
          
          await window.loadProxiedGameIframe();
          document.getElementById('gameFrameEmbed').onload = hidePreloader;
          
          document.getElementById('gameTitleDisplayFrame').textContent = currentGame.title || "";
          renderStarRatingUI("Frame");
          renderTagsAreaFrame(currentGame);
          renderCategoryGamesCountFrame(currentGame);
          renderGameInfoBox(currentGame, "gameInfoTableFrame");
          
          // Load comments when game starts
          await loadComments(currentGameId);
          
          // Initialize comment system event listeners
          initializeCommentSystem();
          
          let lists = await getUserGameLists(user.uid);
          setButtonActive(document.getElementById('likeBtn'), lists.likedGames?.includes(currentGameId));
          setButtonActive(document.getElementById('favBtn'), lists.favoriteGames?.includes(currentGameId), 'bg-pink-600/80');
          setButtonActive(document.getElementById('playlistBtn'), lists.playlist?.includes(currentGameId), 'bg-yellow-400/80');
          
          document.getElementById('likeBtn').onclick = async () => {
            const isLiked = lists.likedGames?.includes(currentGameId);
            await updateUserArray(user.uid, 'likedGames', currentGameId, !isLiked);
            lists = await getUserGameLists(user.uid);
            setButtonActive(document.getElementById('likeBtn'), lists.likedGames?.includes(currentGameId));
          };
          
          document.getElementById('favBtn').onclick = async () => {
            const isFav = lists.favoriteGames?.includes(currentGameId);
            await updateUserArray(user.uid, 'favoriteGames', currentGameId, !isFav);
            lists = await getUserGameLists(user.uid);
            setButtonActive(document.getElementById('favBtn'), lists.favoriteGames?.includes(currentGameId), 'bg-pink-600/80');
          };
          
          document.getElementById('dislikeBtn').onclick = async () => {
            const isLiked = lists.likedGames?.includes(currentGameId);
            if (isLiked) {
              await updateUserArray(user.uid, 'likedGames', currentGameId, false);
            }
            alert('Game disliked!');
            lists = await getUserGameLists(user.uid);
            setButtonActive(document.getElementById('likeBtn'), lists.likedGames?.includes(currentGameId));
          };
          
          document.getElementById('shareBtn').onclick = () => {
            const url = `${window.location.origin}/play.html?id=${currentGameId}`;
            navigator.clipboard.writeText(url);
            alert('Game link copied!');
          };
          
          document.getElementById('playlistBtn').onclick = async () => {
            const inPlaylist = lists.playlist?.includes(currentGameId);
            await updateUserArray(user.uid, 'playlist', currentGameId, !inPlaylist);
            lists = await getUserGameLists(user.uid);
            setButtonActive(document.getElementById('playlistBtn'), lists.playlist?.includes(currentGameId), 'bg-yellow-400/80');
          };
          
          document.getElementById('fullscreenBtn').onclick = (e) => {
            e.preventDefault();
            const iframe = document.getElementById('gameFrameEmbed');
            requestFullScreen(iframe);
          };
          
          document.getElementById('fullscreenBtnBottom').onclick = (e) => {
            e.preventDefault();
            const iframe = document.getElementById('gameFrameEmbed');
            requestFullScreen(iframe);
          };
        };
        
        hidePreloader();
      });
    });

    // User functions
    async function getUserDocRef(uid) {
      return db.collection('users').doc(uid);
    }
    
    async function updateUserArray(uid, field, gameId, add = true) {
      const ref = await getUserDocRef(uid);
      if (add) {
        await ref.set({ [field]: firebase.firestore.FieldValue.arrayUnion(gameId) }, { merge: true });
      } else {
        await ref.set({ [field]: firebase.firestore.FieldValue.arrayRemove(gameId) }, { merge: true });
      }
    }
    
    async function getUserGameLists(uid) {
      const doc = await db.collection('users').doc(uid).get();
      return doc.exists ? doc.data() : { likedGames: [], favoriteGames: [], playlist: [], history: [] };
    }
    
    async function updateGameHistory(uid, gameId) {
      const ref = await getUserDocRef(uid);
      await ref.set({ history: firebase.firestore.FieldValue.arrayUnion(gameId) }, { merge: true });
    }

    // Initialize comment form event listeners after DOM is ready
    function setupCommentEventListeners() {
      // Comment form events
      const commentText = document.getElementById('commentText');
      const commentCharCount = document.getElementById('commentCharCount');
      const submitCommentBtn = document.getElementById('submitComment');
      const cancelComment = document.getElementById('cancelComment');
      const commentFilter = document.getElementById('commentFilter');
      
      if (commentText) {
        commentText.addEventListener('input', () => {
          const length = commentText.value.length;
          if (commentCharCount) commentCharCount.textContent = `${length}/1000`;
          updateSubmitButtonState();
        });
      }
      
      if (submitCommentBtn) {
        submitCommentBtn.addEventListener('click', submitComment);
      }
      
      if (cancelComment) {
        cancelComment.addEventListener('click', () => {
          if (commentText) commentText.value = '';
          commentsData.currentCommentRating = 0;
          updateCommentStarInput();
          updateSubmitButtonState();
        });
      }
      
      if (commentFilter) {
        commentFilter.addEventListener('change', (e) => {
          commentsData.currentFilter = e.target.value;
          updateCommentsUI();
        });
      }
      
      // Reply form events
      const replyText = document.getElementById('replyText');
      const replyCharCount = document.getElementById('replyCharCount');
      const submitReplyBtn = document.getElementById('submitReply');
      
      if (replyText) {
        replyText.addEventListener('input', () => {
          const length = replyText.value.length;
          if (replyCharCount) replyCharCount.textContent = `${length}/500`;
          updateReplyButtonState();
        });
      }
      
      if (submitReplyBtn) {
        submitReplyBtn.addEventListener('click', submitReply);
      }
      
      // Load more comments
      const loadMoreBtn = document.querySelector('#loadMoreComments button');
      if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', () => {
          loadComments(currentGameId, true);
        });
      }
      
      // Hide reaction picker when clicking outside
      document.addEventListener('click', (e) => {
        const picker = document.getElementById('reactionPicker');
        if (picker && !picker.contains(e.target) && !picker.classList.contains('hidden')) {
          hideReactionPicker();
        }
      });
      
      // Initialize comment star input
      initCommentStarInput();
    }

    // Setup event listeners when the game loads
    function initializeCommentSystem() {
      // Set up form event listeners with a slight delay to ensure DOM elements exist
      setTimeout(setupCommentEventListeners, 100);
    }
  </script>
</body>
</html>
